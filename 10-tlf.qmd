---
title: "TLFs: Table, Figure, Listing"
---

```{r}
library(dplyr)
library(gt)
library(ggplot2)
library(survival)

```

We reuse `adsl` from the previous chapter (or synthesize if missing).

```{r}
if (!exists("adsl")) {
  set.seed(123)
  adsl <- tibble::tibble(
    USUBJID = sprintf("XYZ-%03d", 1:60),
    TRT01P = sample(c("Placebo","Active"), 60, replace=TRUE),
    AGE = round(rnorm(60, 60, 8)),
    SEX = sample(c("M","F"), 60, replace=TRUE)
  )
}
```

## Table 1: Baseline Characteristics by Treatment
```{r}
tbl1 <- adsl |>
  group_by(TRT01P) |>
  summarise(
    N = dplyr::n(),
    mean_age = mean(AGE, na.rm=TRUE),
    sd_age = sd(AGE, na.rm=TRUE),
    pct_female = mean(SEX == "F")*100
  )

gt(tbl1) |>
  tab_header(title = "Table 1. Baseline Characteristics by Treatment") |>
  fmt_number(columns = c(mean_age, sd_age, pct_female), decimals = 1)
```

## Figure: (Toy) Survival Curve
We simulate time-to-event data for illustration only.

```{r}
set.seed(42)
n <- nrow(adsl)
adsl$time <- rexp(n, rate = ifelse(adsl$TRT01P=="Active", 0.08, 0.1))
adsl$status <- rbinom(n, 1, 0.7)
fit <- survival::survfit(survival::Surv(time, status) ~ TRT01P, data = adsl)

# Quick GGplot
ggsurv <- function(fit) {
  # rebuild data for plotting
  ss <- summary(fit)
  dd <- data.frame(
    time = ss$time,
    surv = ss$surv,
    strata = rep(names(fit$strata), fit$strata)
  )
  ggplot(dd, aes(x=time, y=surv, linetype=strata)) +
    geom_step() +
    labs(title="Kaplan–Meier (Toy Data)", x="Time", y="Survival Probability", linetype="Treatment") +
    theme_minimal()
}
#ggsurv(fit)
```

## Listing: Subject-Level Listing
```{r}
lst <- adsl |>
  arrange(USUBJID) |>
  select(USUBJID, TRT01P, AGE, SEX) |>
  head(20)

gt(lst) |>
  tab_header(title = "Listing: First 20 Subjects")
```

**Exercises**
1. Format Table 1 to `N (mean ± SD)` for age.
2. Add risk table to the KM plot (use an extension like survminer outside of this minimal example).
3. Create a listing that includes population flags once you derive them.
